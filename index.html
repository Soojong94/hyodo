<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#1e3a5f">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="ë§ˆì´ë„ˆìŠ¤ í†µì¥">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" sizes="180x180" href="icon-192.png">
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
  <meta property="og:title" content="ë§ˆì´ë„ˆìŠ¤ í†µì¥">
  <meta property="og:description" content="ê°„í¸í•œ ìƒí™˜ ê´€ë¦¬ ì•±">
  <meta property="og:image" content="icon-512.png">
  <meta name="description" content="ê°„í¸í•œ ìƒí™˜ ê´€ë¦¬ ì•± - ë§ˆì´ë„ˆìŠ¤ í†µì¥">
  <title>ë§ˆì´ë„ˆìŠ¤ í†µì¥</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;900&display=swap');
    * { font-family: 'Noto Sans KR', sans-serif; -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
    body { background: #f0f4f8; overscroll-behavior: none; -webkit-user-select: none; user-select: none; }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    .modal-overlay { background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
    .fade-in { animation: fadeIn 0.25s ease-out; }
    @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
    .keypad-btn {
      display:flex; align-items:center; justify-content:center;
      font-size:1.75rem; font-weight:700; border-radius:1rem;
      background:#fff; color:#1e3a5f; border:2px solid #e2e8f0;
      transition:all 0.1s; min-height:4rem; cursor:pointer;
    }
    .keypad-btn:active { background:#e2e8f0; transform:scale(0.95); }
    .quick-btn {
      background:#e8f0fe; color:#1e3a5f; font-weight:700; font-size:1rem;
      padding:0.6rem 0.5rem; border-radius:1rem; border:2px solid #bdd0ec;
      cursor:pointer; transition:all 0.1s;
    }
    .quick-btn:active { background:#bdd0ec; transform:scale(0.95); }
    .setup-input {
      font-size:2rem; font-weight:900; text-align:center;
      border:3px solid #1e3a5f; border-radius:1rem; padding:1rem;
      width:100%; color:#1e3a5f; background:#fff; outline:none;
    }
    .setup-input:focus { border-color:#2563eb; box-shadow:0 0 0 4px rgba(37,99,235,0.2); }
    .auth-input {
      width:100%; text-align:center; font-size:1.25rem; font-weight:700;
      padding:1rem; border:2px solid #e2e8f0; border-radius:1rem;
      outline:none; transition:all 0.2s; background:#fff; color:#1e3a5f;
    }
    .auth-input:focus { border-color:#2563eb; box-shadow:0 0 0 4px rgba(37,99,235,0.15); }
    .auth-input::placeholder { color:#cbd5e1; font-weight:400; }
  </style>
</head>
<body class="min-h-screen">

  <!-- ==================== ë¡œê·¸ì¸/íšŒì›ê°€ì… í™”ë©´ ==================== -->
  <div id="authScreen" class="min-h-screen flex items-center justify-center px-6">
    <div class="w-full max-w-sm text-center fade-in">
      <!-- ë¡œê³  -->
      <div class="mb-8">
        <div class="w-24 h-24 bg-gradient-to-br from-[#1e3a5f] to-[#2563eb] rounded-3xl mx-auto flex items-center justify-center shadow-lg mb-6">
          <span class="text-5xl">ğŸ’°</span>
        </div>
        <h1 class="text-3xl font-black text-[#1e3a5f]">ë§ˆì´ë„ˆìŠ¤ í†µì¥</h1>
        <p class="text-gray-400 mt-2 text-lg">ëˆ ê°šì•„ë¼</p>
      </div>

      <!-- ë¡œê·¸ì¸ í¼ -->
      <div id="loginForm" class="space-y-3">
        <input id="loginId" type="email" placeholder="ì´ë©”ì¼" class="auth-input"
          onkeydown="if(event.key==='Enter') document.getElementById('loginPw').focus()">
        <input id="loginPw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" class="auth-input"
          onkeydown="if(event.key==='Enter') doLogin()">
        <button onclick="doLogin()"
          class="w-full bg-[#1e3a5f] text-white text-xl font-bold py-4 rounded-2xl active:bg-[#152d4a] transition-all active:scale-95">
          ë¡œê·¸ì¸
        </button>
        <p id="loginError" class="text-red-500 font-bold text-base hidden"></p>
        <p class="text-gray-400 text-base mt-4">
          ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”?
          <button onclick="showSignup()" class="text-blue-500 font-bold active:text-blue-700 ml-1">íšŒì›ê°€ì…</button>
        </p>
      </div>

      <!-- íšŒì›ê°€ì… í¼ -->
      <div id="signupForm" class="space-y-3 hidden">
        <input id="signupId" type="email" placeholder="ì´ë©”ì¼" class="auth-input"
          onkeydown="if(event.key==='Enter') document.getElementById('signupPw').focus()">
        <input id="signupPw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ (4ì ì´ìƒ)" class="auth-input"
          onkeydown="if(event.key==='Enter') doSignup()">
        <button onclick="doSignup()"
          class="w-full bg-green-500 text-white text-xl font-bold py-4 rounded-2xl active:bg-green-700 transition-all active:scale-95">
          ê°€ì…í•˜ê¸°
        </button>
        <p id="signupError" class="text-red-500 font-bold text-base hidden"></p>
        <p id="signupSuccess" class="text-green-600 font-bold text-base hidden"></p>
        <p class="text-gray-400 text-base mt-4">
          ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”?
          <button onclick="showLogin()" class="text-blue-500 font-bold active:text-blue-700 ml-1">ë¡œê·¸ì¸</button>
        </p>
      </div>
    </div>
  </div>

  <!-- ==================== ë©”ì¸ ì•± ==================== -->
  <div id="appScreen" class="hidden max-w-lg mx-auto pb-24">

    <!-- í—¤ë” -->
    <header class="bg-gradient-to-br from-[#1e3a5f] to-[#2563eb] text-white px-6 pt-8 pb-6 rounded-b-3xl shadow-lg">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-2xl font-bold">ë§ˆì´ë„ˆìŠ¤ í†µì¥</h1>
          <p class="text-blue-200 text-base" id="welcomeText">ëˆ ê°šì•„ë¼</p>
        </div>
        <button onclick="doLogout()" class="text-blue-200 active:text-white text-sm bg-white/10 px-3 py-2 rounded-xl transition-colors">
          ë¡œê·¸ì•„ì›ƒ
        </button>
      </div>

      <!-- ë‚¨ì€ ê¸ˆì•¡ -->
      <div class="mt-6 bg-white/15 rounded-2xl p-6 text-center">
        <p class="text-blue-200 text-lg mb-1">ë‚¨ì€ ê¸ˆì•¡</p>
        <p class="text-5xl font-black tracking-tight" id="remainingAmount">0ì›</p>
      </div>

      <!-- ì´ê¸ˆì•¡ / ê°šì€ ê¸ˆì•¡ -->
      <div class="mt-4 flex gap-3">
        <div class="flex-1 bg-white/10 rounded-xl p-3 text-center">
          <p class="text-blue-200 text-sm">ì´ ê¸ˆì•¡</p>
          <p class="text-xl font-bold" id="totalAmount">0ì›</p>
        </div>
        <div class="flex-1 bg-white/10 rounded-xl p-3 text-center">
          <p class="text-blue-200 text-sm">ê°šì€ ê¸ˆì•¡</p>
          <p class="text-xl font-bold" id="paidAmount">0ì›</p>
        </div>
      </div>

      <!-- ì§„í–‰ë¥  ë°” -->
      <div class="mt-4 bg-white/20 rounded-full h-4 overflow-hidden">
        <div class="bg-green-400 h-full rounded-full transition-all duration-500" id="progressBar" style="width:0%"></div>
      </div>
      <p class="text-center text-blue-200 text-sm mt-1" id="progressText">0% ì™„ë£Œ</p>
    </header>

    <!-- ìƒí™˜ / ì¶”ê°€ ì§€ì¶œ ë²„íŠ¼ -->
    <div class="px-6 mt-6 flex gap-3">
      <button onclick="openPaymentModal('repayment')"
        class="flex-1 bg-green-500 hover:bg-green-600 active:bg-green-700 text-white text-xl font-bold py-5 rounded-2xl shadow-lg flex items-center justify-center gap-2 transition-all active:scale-95">
        <span class="text-2xl">-</span>
        <span>ìƒí™˜</span>
      </button>
      <button onclick="openPaymentModal('spend')"
        class="flex-1 bg-orange-500 hover:bg-orange-600 active:bg-orange-700 text-white text-xl font-bold py-5 rounded-2xl shadow-lg flex items-center justify-center gap-2 transition-all active:scale-95">
        <span class="text-2xl">+</span>
        <span>ì¶”ê°€ ëŒ€ì¶œ</span>
      </button>
    </div>

    <!-- ìµœê·¼ ë‚´ì—­ ë¯¸ë¦¬ë³´ê¸° -->
    <div class="px-6 mt-8">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold text-gray-700">ìµœê·¼ ë‚´ì—­</h2>
        <a href="history.html" class="text-blue-500 font-bold text-base active:text-blue-700">ì „ì²´ë³´ê¸° â†’</a>
      </div>
      <div id="recentList" class="space-y-2"></div>
      <div id="emptyState" class="text-center py-10 text-gray-400">
        <p class="text-5xl mb-3">ğŸ“‹</p>
        <p class="text-lg">ì•„ì§ ìƒí™˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</p>
      </div>
    </div>

    <!-- ì„¤ì • ë²„íŠ¼ë“¤ -->
    <div class="px-6 mt-8 space-y-3">
      <button onclick="openSetupModal()"
        class="w-full bg-white text-gray-600 text-lg font-semibold py-4 rounded-xl border-2 border-gray-200 active:bg-gray-100 transition-all">
        ì´ ê¸ˆì•¡ ì„¤ì •
      </button>
      <div class="flex gap-3">
        <button onclick="exportData()"
          class="flex-1 bg-white text-gray-500 text-base font-semibold py-3 rounded-xl border-2 border-gray-200 active:bg-gray-100 transition-all">
          ë°ì´í„° ë‚´ë³´ë‚´ê¸°
        </button>
        <button onclick="openImportModal()"
          class="flex-1 bg-white text-gray-500 text-base font-semibold py-3 rounded-xl border-2 border-gray-200 active:bg-gray-100 transition-all">
          ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        </button>
      </div>
      <button onclick="openDeleteAccountModal()"
        class="w-full text-red-400 text-sm font-semibold py-3 active:text-red-600 transition-all mt-2">
        íšŒì›íƒˆí‡´
      </button>
    </div>

  </div>

  <!-- ========== íšŒì›íƒˆí‡´ í™•ì¸ ëª¨ë‹¬ ========== -->
  <div id="deleteAccountModal" class="fixed inset-0 z-50 hidden">
    <div class="modal-overlay absolute inset-0" onclick="closeDeleteAccountModal()"></div>
    <div class="absolute inset-x-4 top-1/2 -translate-y-1/2 bg-white rounded-3xl shadow-2xl p-8 fade-in max-w-lg mx-auto">
      <h3 class="text-2xl font-bold text-red-500 text-center mb-2">íšŒì›íƒˆí‡´</h3>
      <p class="text-gray-500 text-center text-lg mb-6">íƒˆí‡´í•˜ë©´ ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤.<br>ì •ë§ íƒˆí‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
      <div class="flex gap-3">
        <button onclick="closeDeleteAccountModal()"
          class="flex-1 bg-gray-100 text-gray-600 text-xl font-bold py-4 rounded-xl active:bg-gray-200 transition-all">ì·¨ì†Œ</button>
        <button onclick="confirmDeleteAccount()"
          class="flex-1 bg-red-500 text-white text-xl font-bold py-4 rounded-xl active:bg-red-700 transition-all">íƒˆí‡´</button>
      </div>
    </div>
  </div>

  <!-- í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
  <nav id="bottomNav" class="hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 flex max-w-lg mx-auto shadow-[0_-2px_10px_rgba(0,0,0,0.05)]"></nav>

  <!-- ========== ìƒí™˜ ì…ë ¥ ëª¨ë‹¬ ========== -->
  <div id="paymentModal" class="fixed inset-0 z-50 hidden">
    <div class="modal-overlay absolute inset-0" onclick="closePaymentModal()"></div>
    <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-3xl shadow-2xl p-6 fade-in max-w-lg mx-auto">
      <div class="w-12 h-1.5 bg-gray-300 rounded-full mx-auto mb-4"></div>
      <h3 id="modalTitle" class="text-xl font-bold text-gray-700 text-center mb-2">ìƒí™˜ ê¸ˆì•¡ ì…ë ¥</h3>
      <div class="bg-gray-50 rounded-2xl p-4 mb-4 text-center">
        <p id="inputDisplay" class="text-4xl font-black text-[#1e3a5f]">0ì›</p>
      </div>
      <div class="grid grid-cols-4 gap-2 mb-4">
        <button class="quick-btn" onclick="addQuickAmount(10000)">+1ë§Œ</button>
        <button class="quick-btn" onclick="addQuickAmount(50000)">+5ë§Œ</button>
        <button class="quick-btn" onclick="addQuickAmount(100000)">+10ë§Œ</button>
        <button class="quick-btn" onclick="addQuickAmount(500000)">+50ë§Œ</button>
      </div>
      <input id="dateInput" type="date"
        class="w-full text-base p-3 border-2 border-gray-200 rounded-xl mb-2 outline-none focus:border-blue-400 text-[#1e3a5f] font-semibold">
      <input id="memoInput" type="text" placeholder="ë©”ëª¨ (ì„ íƒ)"
        class="w-full text-base p-3 border-2 border-gray-200 rounded-xl mb-4 outline-none focus:border-blue-400">
      <div class="grid grid-cols-3 gap-2 mb-4">
        <button class="keypad-btn" onclick="pressKey('1')">1</button>
        <button class="keypad-btn" onclick="pressKey('2')">2</button>
        <button class="keypad-btn" onclick="pressKey('3')">3</button>
        <button class="keypad-btn" onclick="pressKey('4')">4</button>
        <button class="keypad-btn" onclick="pressKey('5')">5</button>
        <button class="keypad-btn" onclick="pressKey('6')">6</button>
        <button class="keypad-btn" onclick="pressKey('7')">7</button>
        <button class="keypad-btn" onclick="pressKey('8')">8</button>
        <button class="keypad-btn" onclick="pressKey('9')">9</button>
        <button class="keypad-btn text-red-500 border-red-200" onclick="pressKey('clear')">C</button>
        <button class="keypad-btn" onclick="pressKey('0')">0</button>
        <button class="keypad-btn text-orange-500 border-orange-200" onclick="pressKey('back')">â†</button>
      </div>
      <button id="confirmPaymentBtn" onclick="confirmPayment()"
        class="w-full bg-green-500 active:bg-green-700 text-white text-2xl font-bold py-4 rounded-2xl transition-all active:scale-95">
        ìƒí™˜ ì™„ë£Œ
      </button>
    </div>
  </div>

  <!-- ========== ì´ê¸ˆì•¡ ì„¤ì • ëª¨ë‹¬ ========== -->
  <div id="setupModal" class="fixed inset-0 z-50 hidden">
    <div class="modal-overlay absolute inset-0" onclick="closeSetupModal()"></div>
    <div class="absolute inset-x-4 top-1/2 -translate-y-1/2 bg-white rounded-3xl shadow-2xl p-8 fade-in max-w-lg mx-auto">
      <h3 class="text-2xl font-bold text-gray-700 text-center mb-2">ì´ ê¸ˆì•¡ ì„¤ì •</h3>
      <p class="text-gray-400 text-center mb-6">ê°šì•„ì•¼ í•  ì „ì²´ ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”</p>
      <input id="setupInput" type="number" inputmode="numeric" placeholder="ê¸ˆì•¡ ì…ë ¥" class="setup-input mb-6">
      <div class="flex gap-3">
        <button onclick="closeSetupModal()"
          class="flex-1 bg-gray-100 text-gray-600 text-xl font-bold py-4 rounded-xl active:bg-gray-200 transition-all">ì·¨ì†Œ</button>
        <button onclick="confirmSetup()"
          class="flex-1 bg-[#1e3a5f] text-white text-xl font-bold py-4 rounded-xl active:bg-[#152d4a] transition-all">í™•ì¸</button>
      </div>
    </div>
  </div>

  <!-- ========== ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ëª¨ë‹¬ ========== -->
  <div id="importModal" class="fixed inset-0 z-50 hidden">
    <div class="modal-overlay absolute inset-0" onclick="closeImportModal()"></div>
    <div class="absolute inset-x-4 top-1/2 -translate-y-1/2 bg-white rounded-3xl shadow-2xl p-8 fade-in max-w-lg mx-auto">
      <h3 class="text-2xl font-bold text-gray-700 text-center mb-2">ë°ì´í„° ê°€ì ¸ì˜¤ê¸°</h3>
      <p class="text-gray-400 text-center mb-4">ë‚´ë³´ë‚¸ ë°ì´í„°ë¥¼ ì•„ë˜ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”</p>
      <textarea id="importTextarea" rows="6"
        class="w-full text-base p-4 border-2 border-gray-200 rounded-xl mb-4 outline-none focus:border-blue-400 resize-none"
        placeholder="ë°ì´í„°ë¥¼ ì—¬ê¸°ì— ë¶™ì—¬ë„£ê¸°..."></textarea>
      <div class="flex gap-3">
        <button onclick="closeImportModal()"
          class="flex-1 bg-gray-100 text-gray-600 text-xl font-bold py-4 rounded-xl active:bg-gray-200 transition-all">ì·¨ì†Œ</button>
        <button onclick="confirmImport()"
          class="flex-1 bg-[#1e3a5f] text-white text-xl font-bold py-4 rounded-xl active:bg-[#152d4a] transition-all">ê°€ì ¸ì˜¤ê¸°</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase.js"></script>
  <script src="common.js"></script>
  <script>
    let appData = null;
    let inputValue = '0';
    let paymentMode = 'repayment';

    // ============ ë¡œê·¸ì¸ / íšŒì›ê°€ì… ============
    function showLogin() {
      document.getElementById('loginForm').classList.remove('hidden');
      document.getElementById('signupForm').classList.add('hidden');
      document.getElementById('loginId').focus();
    }

    function showSignup() {
      document.getElementById('loginForm').classList.add('hidden');
      document.getElementById('signupForm').classList.remove('hidden');
      document.getElementById('signupId').focus();
    }

    function showAuthError(elemId, msg) {
      const el = document.getElementById(elemId);
      el.textContent = msg;
      el.classList.remove('hidden');
      setTimeout(() => el.classList.add('hidden'), 3000);
    }

    function setAuthLoading(formType, loading) {
      const isLogin = formType === 'login';
      const btn = isLogin
        ? document.querySelector('#loginForm button[onclick="doLogin()"]')
        : document.querySelector('#signupForm button[onclick="doSignup()"]');
      if (!btn) return;
      if (loading) {
        btn.disabled = true;
        btn.dataset.origText = btn.textContent;
        btn.textContent = isLogin ? 'ë¡œê·¸ì¸ ì¤‘...' : 'ê°€ì… ì¤‘...';
        btn.classList.add('opacity-70');
      } else {
        btn.disabled = false;
        btn.textContent = btn.dataset.origText || (isLogin ? 'ë¡œê·¸ì¸' : 'ê°€ì…í•˜ê¸°');
        btn.classList.remove('opacity-70');
      }
    }

    async function doLogin() {
      const email = document.getElementById('loginId').value.trim();
      const pw = document.getElementById('loginPw').value.trim();

      if (!email || !pw) {
        showAuthError('loginError', 'ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      setAuthLoading('login', true);

      const result = await login(email, pw);
      if (result.ok) {
        await syncData(); // ë¡œê·¸ì¸ ì„±ê³µ í›„ ë°ì´í„° ë™ê¸°í™”
        setAuthLoading('login', false);
        showApp();
      } else {
        setAuthLoading('login', false);
        showAuthError('loginError', result.msg || 'ë¡œê·¸ì¸ ì‹¤íŒ¨');
      }
    }

    async function doSignup() {
      const email = document.getElementById('signupId').value.trim();
      const pw = document.getElementById('signupPw').value.trim();

      if (!email || !pw) { showAuthError('signupError', 'ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
      
      setAuthLoading('signup', true);

      const result = await signup(email, pw);
      if (result.ok) {
        setAuthLoading('signup', false);
        
        // ë°”ë¡œ ë¡œê·¸ì¸ ì„±ê³µí•œ ê²½ìš° (common.js signup ë¡œì§ ì°¸ì¡°)
        if (isAuthenticated()) {
          showApp();
          return;
        }

        const el = document.getElementById('signupSuccess');
        el.textContent = result.msg || 'ê°€ì… ì™„ë£Œ! ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.';
        el.classList.remove('hidden');
        setTimeout(() => {
          el.classList.add('hidden');
          document.getElementById('loginId').value = email;
          document.getElementById('loginPw').value = '';
          showLogin();
          document.getElementById('loginPw').focus();
        }, 1200);
      } else {
        setAuthLoading('signup', false);
        showAuthError('signupError', result.msg || 'ê°€ì… ì‹¤íŒ¨');
      }
    }

    function doLogout() { logout(); }

    // ============ ì•± í‘œì‹œ ============
    function showApp() {
      document.getElementById('authScreen').classList.add('hidden');
      document.getElementById('appScreen').classList.remove('hidden');
      document.getElementById('bottomNav').classList.remove('hidden');

      const user = getCurrentUser();
      document.getElementById('welcomeText').textContent = user + 'ë‹˜, ëˆ ê°šì•„ë¼';

      appData = loadData();
      renderBottomNav('home');
      updateDashboard();
      renderRecentHistory();

      if (appData.totalAmount <= 0) {
        setTimeout(() => openSetupModal(), 300);
      }
    }

    // ============ ëŒ€ì‹œë³´ë“œ ============
    function updateDashboard() {
      const repaid = getPaidTotal(appData);
      const spent = getSpendTotal(appData);
      const effectiveTotal = getEffectiveTotal(appData);
      const netRepaid = Math.max(0, repaid - spent);
      const remaining = Math.max(0, effectiveTotal - repaid);
      const progress = (netRepaid <= 0 || appData.totalAmount <= 0) ? 0 : Math.min(100, (netRepaid / appData.totalAmount) * 100);

      document.getElementById('remainingAmount').textContent = formatMoney(remaining);
      document.getElementById('totalAmount').textContent = formatMoney(effectiveTotal);
      document.getElementById('paidAmount').textContent = formatMoney(netRepaid);
      document.getElementById('progressBar').style.width = progress + '%';

      if (progress >= 100) {
        document.getElementById('progressBar').className = 'bg-yellow-400 h-full rounded-full transition-all duration-500';
        document.getElementById('progressText').textContent = 'ëª¨ë‘ ê°šì•˜ìŠµë‹ˆë‹¤!';
      } else {
        document.getElementById('progressBar').className = 'bg-green-400 h-full rounded-full transition-all duration-500';
        document.getElementById('progressText').textContent = Math.round(progress) + '% ì™„ë£Œ';
      }
    }

    // ============ ìµœê·¼ ë‚´ì—­ (ìµœëŒ€ 5ê°œ) ============
    function renderRecentHistory() {
      const list = document.getElementById('recentList');
      const emptyState = document.getElementById('emptyState');

      if (appData.payments.length === 0) {
        list.innerHTML = '';
        emptyState.classList.remove('hidden');
        return;
      }

      emptyState.classList.add('hidden');
      const sorted = [...appData.payments].sort((a, b) => new Date(b.date) - new Date(a.date));
      const recent = sorted.slice(0, 5);

      let html = '';
      recent.forEach(item => {
        const d = new Date(item.date);
        const dayStr = `${d.getFullYear()}.${d.getMonth()+1}.${d.getDate()}`;
        const memo = item.memo ? `<span class="text-gray-400 text-sm ml-2">${escapeHtml(item.memo)}</span>` : '';
        const isSpend = item.type === 'spend';
        const sign = isSpend ? '+' : '-';
        const amountColor = isSpend ? 'text-orange-500' : 'text-[#1e3a5f]';
        const typeLabel = isSpend
          ? '<span class="text-xs bg-orange-100 text-orange-500 font-bold px-2 py-0.5 rounded-full ml-2">ëŒ€ì¶œ</span>'
          : '<span class="text-xs bg-green-100 text-green-600 font-bold px-2 py-0.5 rounded-full ml-2">ìƒí™˜</span>';
        html += `
          <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100 flex items-center justify-between">
            <div>
              <span class="text-gray-500 text-base font-semibold">${dayStr}</span>
              ${typeLabel}${memo}
            </div>
            <span class="text-xl font-bold ${amountColor}">${sign}${formatMoney(item.amount)}</span>
          </div>
        `;
      });

      if (appData.payments.length > 5) {
        html += `
          <a href="history.html" class="block text-center text-blue-500 font-bold text-base py-3 active:text-blue-700">
            +${appData.payments.length - 5}ê±´ ë”ë³´ê¸°
          </a>
        `;
      }
      list.innerHTML = html;
    }

    // ============ ìƒí™˜/ì§€ì¶œ ì…ë ¥ ============
    function openPaymentModal(mode) {
      paymentMode = mode || 'repayment';
      if (paymentMode === 'repayment' && appData.totalAmount <= 0) { openSetupModal(); return; }
      inputValue = '0';
      document.getElementById('memoInput').value = '';
      document.getElementById('dateInput').value = new Date().toISOString().slice(0, 10);
      updateInputDisplay();

      const title = document.getElementById('modalTitle');
      const confirmBtn = document.getElementById('confirmPaymentBtn');
      if (paymentMode === 'spend') {
        title.textContent = 'ì¶”ê°€ ëŒ€ì¶œ ê¸ˆì•¡ ì…ë ¥';
        confirmBtn.textContent = 'ëŒ€ì¶œ ë“±ë¡';
        confirmBtn.className = 'w-full bg-orange-500 active:bg-orange-700 text-white text-2xl font-bold py-4 rounded-2xl transition-all active:scale-95';
      } else {
        title.textContent = 'ìƒí™˜ ê¸ˆì•¡ ì…ë ¥';
        confirmBtn.textContent = 'ìƒí™˜ ì™„ë£Œ';
        confirmBtn.className = 'w-full bg-green-500 active:bg-green-700 text-white text-2xl font-bold py-4 rounded-2xl transition-all active:scale-95';
      }

      document.getElementById('paymentModal').classList.remove('hidden');
    }
    function closePaymentModal() { document.getElementById('paymentModal').classList.add('hidden'); }

    function updateInputDisplay() {
      document.getElementById('inputDisplay').textContent = formatMoney(parseInt(inputValue) || 0);
    }

    function pressKey(key) {
      if (key === 'clear') { inputValue = '0'; }
      else if (key === 'back') { inputValue = inputValue.length > 1 ? inputValue.slice(0, -1) : '0'; }
      else {
        if (inputValue === '0') inputValue = key;
        else if (inputValue.length < 10) inputValue += key;
      }
      updateInputDisplay();
    }

    function addQuickAmount(amount) {
      inputValue = String((parseInt(inputValue) || 0) + amount);
      updateInputDisplay();
    }

    function confirmPayment() {
      const amount = parseInt(inputValue) || 0;
      if (amount <= 0) { alert('ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }

      if (paymentMode === 'repayment') {
        const remaining = getEffectiveTotal(appData) - getPaidTotal(appData);
        if (amount > remaining) { alert('ë‚¨ì€ ê¸ˆì•¡ë³´ë‹¤ í° ê¸ˆì•¡ì€ ì…ë ¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }
      }

      const selectedDate = document.getElementById('dateInput').value;
      const now = new Date();
      let paymentDate;
      if (selectedDate) {
        const [y, m, d] = selectedDate.split('-').map(Number);
        paymentDate = new Date(y, m - 1, d, now.getHours(), now.getMinutes(), now.getSeconds()).toISOString();
      } else {
        paymentDate = now.toISOString();
      }

      appData.payments.push({
        id: generateId(),
        date: paymentDate,
        amount: amount,
        memo: document.getElementById('memoInput').value.trim(),
        type: paymentMode
      });

      saveData(appData);
      updateDashboard();
      renderRecentHistory();
      closePaymentModal();
    }

    // ============ ì´ê¸ˆì•¡ ì„¤ì • ============
    function openSetupModal() {
      document.getElementById('setupInput').value = appData.totalAmount || '';
      document.getElementById('setupModal').classList.remove('hidden');
      setTimeout(() => document.getElementById('setupInput').focus(), 100);
    }
    function closeSetupModal() { document.getElementById('setupModal').classList.add('hidden'); }

    function confirmSetup() {
      const val = parseInt(document.getElementById('setupInput').value) || 0;
      if (val <= 0) { alert('ì˜¬ë°”ë¥¸ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
      appData.totalAmount = val;
      saveData(appData);
      updateDashboard();
      closeSetupModal();
    }

    // ============ ë°ì´í„° ë‚´ë³´ë‚´ê¸°/ê°€ì ¸ì˜¤ê¸° ============
    function exportData() {
      const text = JSON.stringify({ version: 1, exportDate: new Date().toISOString(), user: getCurrentUser(), data: appData }, null, 2);
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(() => {
          alert('ë°ì´í„°ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.\në©”ëª¨ì¥ì´ë‚˜ ë©”ì‹œì§€ì— ë¶™ì—¬ë„£ê¸° í•˜ì—¬ ë³´ê´€í•˜ì„¸ìš”.');
        }).catch(() => downloadFile(text));
      } else {
        downloadFile(text);
      }
    }

    function downloadFile(text) {
      const blob = new Blob([text], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `ë§ˆì´ë„ˆìŠ¤í†µì¥_ë°±ì—…_${getCurrentUser()}_${new Date().toISOString().slice(0,10)}.json`;
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      URL.revokeObjectURL(a.href);
    }

    function openImportModal() {
      document.getElementById('importTextarea').value = '';
      document.getElementById('importModal').classList.remove('hidden');
    }
    function closeImportModal() { document.getElementById('importModal').classList.add('hidden'); }

    function confirmImport() {
      const text = document.getElementById('importTextarea').value.trim();
      if (!text) { alert('ë°ì´í„°ë¥¼ ë¶™ì—¬ë„£ì–´ ì£¼ì„¸ìš”.'); return; }
      try {
        const parsed = JSON.parse(text);
        const imported = parsed.data || parsed;
        if (typeof imported.totalAmount !== 'number' || !Array.isArray(imported.payments)) throw new Error();
        if (!confirm('í˜„ì¬ ë°ì´í„°ë¥¼ ë®ì–´ì”ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        appData = imported;
        saveData(appData);
        updateDashboard();
        renderRecentHistory();
        closeImportModal();
        alert('ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤.');
      } catch (e) {
        alert('ì˜¬ë°”ë¥´ì§€ ì•Šì€ ë°ì´í„° í˜•ì‹ì…ë‹ˆë‹¤.');
      }
    }

    // ============ íšŒì›íƒˆí‡´ ============
    function openDeleteAccountModal() { document.getElementById('deleteAccountModal').classList.remove('hidden'); }
    function closeDeleteAccountModal() { document.getElementById('deleteAccountModal').classList.add('hidden'); }
    function confirmDeleteAccount() { deleteAccount(); }

    // ============ ì´ˆê¸°í™” ============
    (async function init() {
      const isAuth = await initAuth();
      if (isAuth) {
        // ë¡œê·¸ì¸ ìƒíƒœë©´ ë°ì´í„° ë™ê¸°í™” í›„ ì•± í‘œì‹œ
        await syncData();
        showApp();
      } else {
        // ë¹„ë¡œê·¸ì¸ ìƒíƒœë©´ ë¡œê·¸ì¸ í™”ë©´ í‘œì‹œ
        document.getElementById('authScreen').classList.remove('hidden');
        setTimeout(() => document.getElementById('loginId').focus(), 300);
      }
    })();
  </script>
</body>
</html>
